<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Checklist Harian Leader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .checkbox-custom {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkbox-custom:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .checkbox-custom:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gradient-to-br from-blue-50 to-indigo-100">
  <main class="container mx-auto px-4 py-6 max-w-4xl"><!-- Header -->
   <header class="text-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Sistem Checklist Harian Leader</h1>
    <p class="text-gray-600">Kelola tugas harian tim dengan mudah dan efisien</p>
   </header><!-- Login Section -->
   <section id="loginSection" class="bg-white rounded-xl shadow-lg p-8 mb-6">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Login Leader</h2>
    <form id="loginForm" class="space-y-6">
     <div><label for="division" class="block text-sm font-medium text-gray-700 mb-2">Pilih Divisi</label> <select id="division" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">-- Pilih Divisi --</option> <option value="food">Food</option> <option value="nfood">Non Food</option> <option value="nfm">NFM</option> <option value="kasir">Kasir</option> </select>
     </div>
     <div><label for="leaderName" class="block text-sm font-medium text-gray-700 mb-2">Nama Leader</label> <select id="leaderName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled> <option value="">-- Pilih divisi terlebih dahulu --</option> </select>
     </div>
     <div><label for="npk" class="block text-sm font-medium text-gray-700 mb-2">NPK (Password)</label> <input type="password" id="npk" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan NPK Anda">
     </div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105"> Login </button>
    </form>
   </section><!-- Main Dashboard -->
   <section id="dashboardSection" class="hidden"><!-- Welcome Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
     <div class="flex items-center justify-between">
      <div>
       <h2 class="text-2xl font-bold text-gray-800">Selamat Datang, <span id="welcomeName"></span></h2>
       <p class="text-gray-600">Divisi <span id="welcomeDivision"></span> | NPK: <span id="welcomeNPK"></span></p>
      </div><button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200"> Logout </button>
     </div>
    </div><!-- Shift Selection -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
     <h3 class="text-xl font-semibold text-gray-800 mb-4">Pilih Shift Kerja</h3>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><button class="shift-btn bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-3 px-6 rounded-lg transition duration-200" data-shift="pagi"> Shift Pagi </button> <button class="shift-btn bg-green-100 hover:bg-green-200 text-green-800 font-semibold py-3 px-6 rounded-lg transition duration-200" data-shift="siang"> Shift Siang </button>
     </div>
     <div id="selectedShift" class="mt-4 text-center text-gray-600 hidden">
      Shift terpilih: <span class="font-semibold"></span>
     </div>
    </div><!-- Checklist Sections -->
    <div id="checklistSections" class="space-y-6 hidden"><!-- Team Selection -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Tim yang Bekerja Hari Ini</h3>
      <div id="teamList" class="space-y-3"></div>
      <div class="mt-4 text-center"><button id="saveTeamBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200"> Simpan Tim yang Bekerja </button>
      </div>
      <div id="teamZoneSection" class="mt-6 hidden">
       <h4 class="text-lg font-semibold text-gray-700 mb-3">Penempatan Zona Kerja</h4>
       <div id="teamZoneList" class="space-y-3"></div>
      </div>
     </div><!-- Supplier Selection -->
     <div id="supplierSection" class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Supplier Kiriman Hari Ini</h3>
      <div id="supplierList" class="space-y-3"></div>
     </div><!-- Jobdesk Checklist -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Checklist Jobdesk</h3>
      <div id="jobdeskList" class="space-y-3"></div>
      <div id="jobdeskComments" class="mt-4 space-y-3"></div>
     </div><!-- Reserve Stock -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Turun Reserve</h3>
      <div class="space-y-4">
       <div class="flex items-center space-x-3"><input type="checkbox" id="reserveStock" class="checkbox-custom"> <label for="reserveStock" class="text-gray-700 font-medium">Ada turun reserve hari ini</label>
       </div>
       <div id="reserveComment" class="hidden space-y-3">
        <div><label for="reserveDisplay" class="block text-sm font-medium text-gray-700 mb-2">Display</label> <input type="text" id="reserveDisplay" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan display...">
        </div>
        <div><label for="reserveNote" class="block text-sm font-medium text-gray-700 mb-2">Keterangan Reserve</label> <textarea id="reserveNote" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Tuliskan detail reserve yang diambil..."></textarea>
        </div>
       </div>
      </div>
     </div><!-- SPG Selection -->
     <div id="spgSection" class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">SPG yang Bekerja Hari Ini</h3>
      <div id="spgList" class="space-y-3"></div>
     </div><!-- Submit Button -->
     <div class="text-center"><button id="submitChecklist" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-8 rounded-lg transition duration-200 transform hover:scale-105 shadow-lg"> Submit Checklist Harian </button>
     </div>
    </div>
   </section><!-- Confirmation Modal -->
   <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
     <div class="text-center">
      <div class="mb-4">
       <svg class="mx-auto h-12 w-12 text-yellow-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
       </svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Konfirmasi Submit</h3>
      <p class="text-gray-600 mb-6">Apakah data yang Anda buat sudah yakin dan benar?</p>
      <div class="flex space-x-4"><button id="confirmSubmit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"> Kirim </button> <button id="cancelSubmit" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"> Periksa Kembali </button>
      </div>
     </div>
    </div>
   </div>
  </main>
  <script>
        // Data from spreadsheet - will be loaded dynamically
        let spreadsheetData = {};

        let currentUser = null;
        let currentShift = null;

        // Enhanced data loading with real spreadsheet data
        async function loadSpreadsheetData() {
          console.log('üîó Trying to connect to Apps Script...');
          
          try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbwAcs-_h6SNPoZObj9NZSDLuYrrnTGodXzv_cuJ963nqGhQ_JxlPRU9RQFsALy_9rlt/exec', {
              method: 'GET',
              mode: 'cors'
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('üìä Successfully loaded data from spreadsheet:', data);
            console.log('üìù Available sheets:', Object.keys(data));
            
            // Validate data structure
            const hasValidData = Object.keys(data).some(key => 
              Array.isArray(data[key]) && data[key].length > 0
            );
            
            if (hasValidData) {
              console.log('üéâ Using REAL spreadsheet data');
              showToast('Data berhasil dimuat dari server!', 'success');
              spreadsheetData = data; // Update with real data
              return data;
            }
            
          } catch (error) {
            console.log(`‚ùå Error loading spreadsheet data: ${error}`);
            console.log('‚ö†Ô∏è Using fallback sample data');
            showToast('Menggunakan data sample (koneksi server gagal)', 'info');
          }

          return spreadsheetData; // Return existing data (real or fallback)
        }

        // Get data for specific division and type
        function getDataForDivision(division, type) {
          console.log(`üîç Getting ${type} data for division: ${division}`);
          
          let sheetName = '';
          
          switch (type) {
            case 'team':
              sheetName = division.toLowerCase();
              break;
            case 'spg':
              if (division === 'food') {
                sheetName = 'spg food';
              } else if (division === 'nfood') {
                sheetName = 'spg nfood';
              } else {
                console.log(`‚ÑπÔ∏è No SPG data for division: ${division}`);
                return [];
              }
              break;
            case 'supplier':
              if (division === 'food') {
                sheetName = 'supplier food';
              } else if (division === 'nfood') {
                sheetName = 'supplier nfood';
              } else if (division === 'nfm') {
                sheetName = 'supplier nfm';
              } else {
                console.log(`‚ÑπÔ∏è No supplier data for division: ${division}`);
                return [];
              }
              break;
            case 'jobdesk':
              sheetName = '7 jobdesk';
              break;
          }
          
          console.log(`üîé Looking for sheet: "${sheetName}"`);
          console.log(`üìã Available sheets:`, Object.keys(spreadsheetData));
          
          const data = spreadsheetData[sheetName] || [];
          console.log(`üìä Found ${data.length} items in ${sheetName}:`, data);
          
          return data;
        }

        // Toast notification system
        function showToast(message, type = 'info') {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.textContent = message;
          document.body.appendChild(toast);
          
          setTimeout(() => {
            toast.remove();
          }, 3000);
        }

        // Reset all form states
        function resetAllForms() {
          // Reset all checkboxes
          document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
          });
          
          // Reset reserve fields
          document.getElementById('reserveNote').value = '';
          document.getElementById('reserveDisplay').value = '';
          document.getElementById('reserveComment').classList.add('hidden');
          
          // Reset team zone section
          document.getElementById('teamZoneSection').classList.add('hidden');
          document.getElementById('teamZoneList').innerHTML = '';
          
          // Reset jobdesk comments
          document.getElementById('jobdeskComments').innerHTML = '';
          

          
          // Reset shift selection
          document.querySelectorAll('.shift-btn').forEach(btn => {
            btn.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-200');
          });
          
          // Hide sections
          document.getElementById('checklistSections').classList.add('hidden');
          document.getElementById('selectedShift').classList.add('hidden');
          
          // Reset current shift
          currentShift = null;
          
          console.log('üîÑ All forms reset for new session');
        }

        // Initialize application
        async function init() {
          console.log('üöÄ Initializing application...');
          
          // Load spreadsheet data
          await loadSpreadsheetData();
          
          // Setup event listeners
          setupEventListeners();
          
          console.log('‚úÖ Application initialized successfully');
        }

        // Setup all event listeners
        function setupEventListeners() {
          // Division change handler
          document.getElementById('division').addEventListener('change', function() {
            const division = this.value;
            const leaderSelect = document.getElementById('leaderName');
            const npkInput = document.getElementById('npk');
            
            if (division) {
              const leaders = getDataForDivision(division, 'team');
              console.log(`üë• Loading ${leaders.length} leaders for ${division}:`, leaders);
              
              leaderSelect.innerHTML = '<option value="">-- Pilih Leader --</option>';
              leaders.forEach(leader => {
                const option = document.createElement('option');
                option.value = JSON.stringify(leader);
                option.textContent = leader.name;
                leaderSelect.appendChild(option);
              });
              
              leaderSelect.disabled = false;
              npkInput.value = '';
            } else {
              leaderSelect.innerHTML = '<option value="">-- Pilih divisi terlebih dahulu --</option>';
              leaderSelect.disabled = true;
              npkInput.value = '';
            }
          });

          // Leader selection handler - NPK is now manual input
          document.getElementById('leaderName').addEventListener('change', function() {
            const npkInput = document.getElementById('npk');
            npkInput.value = ''; // Clear NPK field when leader changes
          });

          // Login form handler
          document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const division = document.getElementById('division').value;
            const leaderData = document.getElementById('leaderName').value;
            const inputNpk = document.getElementById('npk').value;
            
            if (!division || !leaderData || !inputNpk) {
              showToast('Mohon lengkapi semua field!', 'error');
              return;
            }
            
            const leader = JSON.parse(leaderData);
            
            // Validate NPK matches the selected leader
            if (inputNpk !== leader.npk) {
              showToast('NPK tidak sesuai dengan leader yang dipilih!', 'error');
              return;
            }
            
            currentUser = {
              division: division,
              name: leader.name,
              npk: leader.npk
            };
            
            console.log('üë§ User logged in:', currentUser);
            
            // Reset all form states
            resetAllForms();
            
            showDashboard();
          });

          // Shift selection handlers
          document.querySelectorAll('.shift-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              // Remove active state from all buttons
              document.querySelectorAll('.shift-btn').forEach(b => {
                b.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-200');
              });
              
              // Add active state to clicked button
              this.classList.add('ring-2', 'ring-blue-500', 'bg-blue-200');
              
              currentShift = this.dataset.shift;
              const shiftText = this.textContent;
              
              document.getElementById('selectedShift').classList.remove('hidden');
              document.getElementById('selectedShift').querySelector('span').textContent = shiftText;
              
              console.log('‚è∞ Shift selected:', currentShift);
              loadChecklistSections();
            });
          });

          // Reserve stock checkbox handler
          document.getElementById('reserveStock').addEventListener('change', function() {
            const commentDiv = document.getElementById('reserveComment');
            if (this.checked) {
              commentDiv.classList.remove('hidden');
            } else {
              commentDiv.classList.add('hidden');
              document.getElementById('reserveNote').value = '';
              document.getElementById('reserveDisplay').value = '';
            }
          });

          // Save team button handler
          document.getElementById('saveTeamBtn').addEventListener('click', function() {
            const checkedTeam = [];
            document.querySelectorAll('input[data-type="team"]:checked').forEach(checkbox => {
              checkedTeam.push({
                npk: checkbox.dataset.npk,
                name: checkbox.dataset.name
              });
            });
            
            if (checkedTeam.length === 0) {
              showToast('Pilih minimal satu anggota tim!', 'error');
              return;
            }
            
            showTeamZoneSection(checkedTeam);
            showToast('Tim berhasil disimpan! Silakan atur zona kerja.', 'success');
          });

          // Logout handler
          document.getElementById('logoutBtn').addEventListener('click', function() {
            currentUser = null;
            currentShift = null;
            
            // Reset all forms and states
            resetAllForms();
            
            // Show login section
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            
            // Reset login form
            document.getElementById('loginForm').reset();
            document.getElementById('leaderName').disabled = true;
            document.getElementById('leaderName').innerHTML = '<option value="">-- Pilih divisi terlebih dahulu --</option>';
            
            showToast('Logout berhasil!', 'success');
          });

          // Submit checklist handler - show confirmation modal
          document.getElementById('submitChecklist').addEventListener('click', function(e) {
            e.preventDefault();
            
            if (!currentUser || !currentShift) {
              showToast('Data login atau shift tidak lengkap!', 'error');
              return;
            }
            
            // Show confirmation modal
            document.getElementById('confirmationModal').classList.remove('hidden');
          });

          // Confirm submit handler
          document.getElementById('confirmSubmit').addEventListener('click', function() {
            // Hide modal
            document.getElementById('confirmationModal').classList.add('hidden');
            
            // Process the actual submission
            handleSubmitChecklist();
          });

          // Cancel submit handler
          document.getElementById('cancelSubmit').addEventListener('click', function() {
            // Just hide the modal, keep all data intact
            document.getElementById('confirmationModal').classList.add('hidden');
          });
        }

        // Show dashboard after login
        function showDashboard() {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('dashboardSection').classList.remove('hidden');
          
          // Update welcome message
          document.getElementById('welcomeName').textContent = currentUser.name;
          document.getElementById('welcomeDivision').textContent = currentUser.division.toUpperCase();
          document.getElementById('welcomeNPK').textContent = currentUser.npk;
          
          showToast(`Selamat datang, ${currentUser.name}!`, 'success');
        }

        // Show team zone section
        function showTeamZoneSection(teamMembers) {
          const zoneSection = document.getElementById('teamZoneSection');
          const zoneList = document.getElementById('teamZoneList');
          
          zoneList.innerHTML = '';
          
          const zones = ['Zona A', 'Zona B', 'Zona C', 'Zona D', 'Kasir', 'Customer Service', 'Gudang'];
          
          teamMembers.forEach(member => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
            div.innerHTML = `
              <span class="font-medium text-gray-700">${member.name}</span>
              <select id="zone_${member.npk}" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">-- Pilih Zona --</option>
                ${zones.map(zone => `<option value="${zone}">${zone}</option>`).join('')}
              </select>
            `;
            zoneList.appendChild(div);
          });
          
          zoneSection.classList.remove('hidden');
        }

        // Load checklist sections based on division and shift
        function loadChecklistSections() {
          console.log('üìã Loading checklist sections for:', currentUser.division);
          
          // Show checklist sections
          document.getElementById('checklistSections').classList.remove('hidden');
          
          // Load team data
          loadTeamSection();
          
          // Load supplier data
          loadSupplierSection();
          
          // Load jobdesk data
          loadJobdeskSection();
          
          // Load SPG data
          loadSPGSection();
        }

        // Load team section
        function loadTeamSection() {
          const teamData = getDataForDivision(currentUser.division, 'team');
          const teamList = document.getElementById('teamList');
          
          teamList.innerHTML = '';
          
          teamData.forEach(member => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3';
            div.innerHTML = `
              <input type="checkbox" id="team_${member.npk}" class="checkbox-custom" data-type="team" data-npk="${member.npk}" data-name="${member.name}">
              <label for="team_${member.npk}" class="text-gray-700 font-medium">${member.name}</label>
            `;
            teamList.appendChild(div);
          });
          
          console.log(`üë• Loaded ${teamData.length} team members`);
        }

        // Load supplier section
        function loadSupplierSection() {
          const supplierData = getDataForDivision(currentUser.division, 'supplier');
          const supplierSection = document.getElementById('supplierSection');
          const supplierList = document.getElementById('supplierList');
          
          if (supplierData.length === 0) {
            supplierSection.classList.add('hidden');
            console.log('üì¶ No supplier data for this division');
            return;
          }
          
          supplierSection.classList.remove('hidden');
          supplierList.innerHTML = '';
          
          supplierData.forEach(supplier => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3';
            div.innerHTML = `
              <input type="checkbox" id="supplier_${supplier.npk}" class="checkbox-custom" data-type="supplier" data-npk="${supplier.npk}">
              <label for="supplier_${supplier.npk}" class="text-gray-700 font-medium">${supplier.name}</label>
            `;
            supplierList.appendChild(div);
          });
          
          console.log(`üì¶ Loaded ${supplierData.length} suppliers`);
        }

        // Load jobdesk section
        function loadJobdeskSection() {
          const jobdeskData = getDataForDivision(currentUser.division, 'jobdesk');
          const jobdeskList = document.getElementById('jobdeskList');
          
          jobdeskList.innerHTML = '';
          
          jobdeskData.forEach(job => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3';
            div.innerHTML = `
              <input type="checkbox" id="jobdesk_${job.npk}" class="checkbox-custom jobdesk-checkbox" data-type="jobdesk" data-npk="${job.npk}" data-name="${job.name}">
              <label for="jobdesk_${job.npk}" class="text-gray-700 font-medium">${job.name}</label>
            `;
            jobdeskList.appendChild(div);
          });
          
          // Add event listeners for jobdesk checkboxes
          document.querySelectorAll('.jobdesk-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
              const jobName = this.dataset.name;
              const jobNpk = this.dataset.npk;
              const commentsContainer = document.getElementById('jobdeskComments');
              
              if (this.checked) {
                // Create comment and photo upload fields
                const commentDiv = document.createElement('div');
                commentDiv.id = `comment_${jobNpk}`;
                commentDiv.className = 'fade-in bg-gray-50 p-4 rounded-lg border';
                commentDiv.innerHTML = `
                  <h4 class="font-semibold text-gray-800 mb-3">${jobName}</h4>
                  
                  <!-- Komentar -->
                  <div class="mb-4">
                    <label for="comment_text_${jobNpk}" class="block text-sm font-medium text-gray-700 mb-2">Komentar</label>
                    <textarea id="comment_text_${jobNpk}" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Tuliskan komentar untuk ${jobName}..."></textarea>
                  </div>
                  
                  <!-- Upload Foto Before -->
                  <div class="mb-4">
                    <label for="photo_before_${jobNpk}" class="block text-sm font-medium text-gray-700 mb-2">Foto Before (Opsional)</label>
                    <input type="file" id="photo_before_${jobNpk}" accept="image/*" capture="environment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <div id="preview_before_${jobNpk}" class="mt-2 hidden">
                      <img class="w-32 h-32 object-cover rounded-lg border" alt="Preview Before">
                      <p class="text-xs text-gray-500 mt-1">Foto Before</p>
                    </div>
                  </div>
                  
                  <!-- Upload Foto After -->
                  <div class="mb-4">
                    <label for="photo_after_${jobNpk}" class="block text-sm font-medium text-gray-700 mb-2">Foto After (Opsional)</label>
                    <input type="file" id="photo_after_${jobNpk}" accept="image/*" capture="environment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <div id="preview_after_${jobNpk}" class="mt-2 hidden">
                      <img class="w-32 h-32 object-cover rounded-lg border" alt="Preview After">
                      <p class="text-xs text-gray-500 mt-1">Foto After</p>
                    </div>
                  </div>
                  
                  <!-- Upload Status -->
                  <div id="upload_status_${jobNpk}" class="hidden">
                    <div class="flex items-center space-x-2 text-sm">
                      <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                      <span class="text-blue-600">Mengupload foto ke Google Drive...</span>
                    </div>
                  </div>
                `;
                commentsContainer.appendChild(commentDiv);
                
                // Add photo preview functionality
                setupPhotoPreview(jobNpk);
                
              } else {
                // Remove comment and photo fields
                const commentDiv = document.getElementById(`comment_${jobNpk}`);
                if (commentDiv) {
                  commentDiv.remove();
                }
              }
            });
          });
          
          console.log(`üìù Loaded ${jobdeskData.length} jobdesk items`);
        }

        // Setup photo preview functionality
        function setupPhotoPreview(jobNpk) {
          const beforeInput = document.getElementById(`photo_before_${jobNpk}`);
          const afterInput = document.getElementById(`photo_after_${jobNpk}`);
          
          if (beforeInput) {
            beforeInput.addEventListener('change', function(e) {
              handlePhotoPreview(e, `preview_before_${jobNpk}`);
            });
          }
          
          if (afterInput) {
            afterInput.addEventListener('change', function(e) {
              handlePhotoPreview(e, `preview_after_${jobNpk}`);
            });
          }
        }

        // Handle photo preview
        function handlePhotoPreview(event, previewId) {
          const file = event.target.files[0];
          const previewDiv = document.getElementById(previewId);
          
          if (file && previewDiv) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const img = previewDiv.querySelector('img');
              img.src = e.target.result;
              previewDiv.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
          }
        }

        // Load SPG section
        function loadSPGSection() {
          const spgData = getDataForDivision(currentUser.division, 'spg');
          const spgSection = document.getElementById('spgSection');
          const spgList = document.getElementById('spgList');
          
          if (spgData.length === 0) {
            spgSection.classList.add('hidden');
            console.log('üë©‚Äçüíº No SPG data for this division');
            return;
          }
          
          spgSection.classList.remove('hidden');
          spgList.innerHTML = '';
          
          spgData.forEach(spg => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3';
            // Display brand automatically from spreadsheet data
            const brandText = spg.brand ? ` (${spg.brand})` : '';
            div.innerHTML = `
              <input type="checkbox" id="spg_${spg.npk}" class="checkbox-custom" data-type="spg" data-npk="${spg.npk}" data-brand="${spg.brand || ''}">
              <label for="spg_${spg.npk}" class="text-gray-700 font-medium">${spg.name}${brandText}</label>
            `;
            spgList.appendChild(div);
          });
          
          console.log(`üë©‚Äçüíº Loaded ${spgData.length} SPG members`);
        }

        // Generate WhatsApp report message
        function generateWhatsAppReport(submissionData) {
          const now = new Date();
          const hour = now.getHours();
          
          // Determine greeting based on time
          let greeting = '';
          if (hour >= 12 && hour < 18) {
            greeting = 'Selamat siang';
          } else if (hour >= 18 || hour < 6) {
            greeting = 'Selamat malam';
          } else {
            greeting = 'Selamat pagi';
          }
          
          // Get team names from spreadsheet data
          const teamData = getDataForDivision(currentUser.division, 'team');
          const teamNames = submissionData.checklist.team.map(member => {
            const teamMember = teamData.find(t => t.npk === member.npk);
            return teamMember ? `${teamMember.name} (${member.zone || 'Zona belum ditentukan'})` : member.name;
          });
          
          // Get supplier names from spreadsheet data
          const supplierData = getDataForDivision(currentUser.division, 'supplier');
          const supplierNames = submissionData.checklist.supplier.map(supplierNpk => {
            const supplier = supplierData.find(s => s.npk === supplierNpk);
            return supplier ? supplier.name : supplierNpk;
          });
          
          // Format jobdesk with comments and photo links
          const jobdeskList = submissionData.checklist.jobdesk.map(job => {
            let jobText = `- ${job.name}`;
            
            if (job.comment) {
              jobText += ` (${job.comment})`;
            }
            
            // Add photo links if available
            const photoLinks = [];
            if (job.photos?.before?.success) {
              photoLinks.push(`üì∏ Before: ${job.photos.before.fileUrl}`);
            }
            if (job.photos?.after?.success) {
              photoLinks.push(`üì∏ After: ${job.photos.after.fileUrl}`);
            }
            
            if (photoLinks.length > 0) {
              jobText += `\n  ${photoLinks.join('\n  ')}`;
            }
            
            return jobText;
          }).join('\n');
          
          // Format reserve information
          let reserveInfo = 'Tidak ada';
          if (submissionData.checklist.reserve.checked) {
            const display = submissionData.checklist.reserve.display || 'Tidak disebutkan';
            const note = submissionData.checklist.reserve.note || 'Tidak ada keterangan';
            reserveInfo = `Display: ${display}\nKeterangan: ${note}`;
          }
          
          // Get SPG names with brands from spreadsheet data
          const spgData = getDataForDivision(currentUser.division, 'spg');
          const spgNames = submissionData.checklist.spg.map(spgItem => {
            const spg = spgData.find(s => s.npk === spgItem.npk);
            const brand = spgItem.brand || (spg ? spg.brand : '');
            const brandText = brand ? ` (${brand})` : '';
            return spg ? `${spg.name}${brandText}` : spgItem.npk;
          });
          
          // Determine closing greeting
          let closingGreeting = '';
          if (hour >= 12 && hour < 18) {
            closingGreeting = 'selamat siang';
          } else if (hour >= 18 || hour < 6) {
            closingGreeting = 'selamat malam';
          } else {
            closingGreeting = 'selamat pagi';
          }
          
          // Build the message
          const message = `${greeting}

Nama: ${submissionData.leader.name}
Leader Shift: ${submissionData.shift === 'pagi' ? 'Shift Pagi' : 'Shift Siang'}

Dengan team karyawan total: ${teamNames.length} orang
${teamNames.length > 0 ? teamNames.map(name => `- ${name}`).join('\n') : '- Tidak ada tim yang dipilih'}

Supplier yang hari ini datang:
${supplierNames.length > 0 ? supplierNames.map(name => `- ${name}`).join('\n') : '- Tidak ada supplier'}

Jobdesk terlaksana:
${jobdeskList || '- Tidak ada jobdesk yang diselesaikan'}

Turun reserve/isi display:
${reserveInfo}

SPG yang bertugas pada shift ini:
${spgNames.length > 0 ? spgNames.map(name => `- ${name}`).join('\n') : '- Tidak ada SPG'}

Atas perhatiannya saya ucapkan terimakasih
${closingGreeting}`;

          return message;
        }

        // Upload photo to Google Drive via Apps Script - CORS-Compatible Method
        async function uploadPhotoToGoogleDrive(file, fileName, jobName) {
          try {
            console.log(`üì∏ Starting upload for ${fileName}...`);
            
            // Validate inputs
            if (!file || !fileName || !jobName) {
              throw new Error('Missing required parameters: file, fileName, or jobName');
            }
            
            if (!currentUser || !currentUser.name || !currentUser.division) {
              throw new Error('Current user data is incomplete');
            }
            
            // Convert file to base64
            const base64Data = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => {
                try {
                  const result = reader.result;
                  if (!result || typeof result !== 'string') {
                    reject(new Error('Failed to read file as base64'));
                    return;
                  }
                  
                  const base64 = result.split(',')[1]; // Remove data:image/jpeg;base64, prefix
                  if (!base64) {
                    reject(new Error('Invalid base64 data'));
                    return;
                  }
                  
                  resolve(base64);
                } catch (error) {
                  reject(error);
                }
              };
              reader.onerror = () => reject(new Error('FileReader error'));
              reader.readAsDataURL(file);
            });
            
            // Create simplified filename with leader name included
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            const timeStr = today.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS format
            
            // Clean up names for filename (remove spaces and special characters)
            const cleanLeaderName = currentUser.name.replace(/[^a-zA-Z0-9]/g, '');
            const cleanJobName = jobName.replace(/[^a-zA-Z0-9]/g, '');
            
            // Simplified filename: Division_LeaderName_JobName_BeforeAfter_Date_Time.jpg
            const simplifiedFileName = `${currentUser.division.toUpperCase()}_${cleanLeaderName}_${cleanJobName}_${fileName.includes('before') ? 'Before' : 'After'}_${dateStr}_${timeStr}.jpg`;
            
            console.log(`üìã Prepared filename: ${simplifiedFileName}`);
            
            // Use JSONP-style approach with dynamic script injection (CORS-free method)
            return new Promise((resolve, reject) => {
              try {
                // Create a unique callback name
                const callbackName = `uploadCallback_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // Create the callback function
                window[callbackName] = function(result) {
                  // Clean up
                  delete window[callbackName];
                  if (script && script.parentNode) {
                    script.parentNode.removeChild(script);
                  }
                  
                  console.log(`üì§ Upload response for ${simplifiedFileName}:`, result);
                  
                  if (result && result.success) {
                    console.log(`‚úÖ Photo ${simplifiedFileName} uploaded successfully`);
                    resolve({
                      success: true,
                      fileUrl: result.fileUrl,
                      fileId: result.fileId,
                      fileName: result.fileName || simplifiedFileName,
                      method: 'JSONP'
                    });
                  } else {
                    console.error(`‚ùå Upload failed for ${simplifiedFileName}:`, result);
                    resolve({
                      success: false,
                      error: result?.error || 'Upload failed',
                      fileName: simplifiedFileName
                    });
                  }
                };
                
                // Prepare upload data
                const uploadData = {
                  action: 'uploadPhoto',
                  fileData: base64Data,
                  fileName: simplifiedFileName,
                  jobName: jobName,
                  leader: currentUser.name,
                  division: currentUser.division,
                  shift: currentShift,
                  timestamp: new Date().toISOString(),
                  mimeType: file.type || 'image/jpeg',
                  fileSize: file.size || 0,
                  callback: callbackName
                };
                
                // Create script element for JSONP
                const script = document.createElement('script');
                const encodedData = encodeURIComponent(JSON.stringify(uploadData));
                script.src = `https://script.google.com/macros/s/AKfycbwAcs-_h6SNPoZObj9NZSDLuYrrnTGodXzv_cuJ963nqGhQ_JxlPRU9RQFsALy_9rlt/exec?data=${encodedData}`;
                
                // Handle script load errors
                script.onerror = function() {
                  console.error(`‚ùå Script load failed for ${simplifiedFileName}`);
                  delete window[callbackName];
                  if (script && script.parentNode) {
                    script.parentNode.removeChild(script);
                  }
                  resolve({
                    success: false,
                    error: 'Network error - script load failed',
                    fileName: simplifiedFileName
                  });
                };
                
                // Set timeout for upload
                setTimeout(() => {
                  if (window[callbackName]) {
                    console.error(`‚ùå Upload timeout for ${simplifiedFileName}`);
                    delete window[callbackName];
                    if (script && script.parentNode) {
                      script.parentNode.removeChild(script);
                    }
                    resolve({
                      success: false,
                      error: 'Upload timeout (30 seconds)',
                      fileName: simplifiedFileName
                    });
                  }
                }, 30000); // 30 second timeout
                
                // Add script to document to trigger the request
                document.head.appendChild(script);
                console.log(`üîÑ JSONP upload initiated for ${simplifiedFileName}`);
                
              } catch (error) {
                console.error(`‚ùå JSONP setup error for ${simplifiedFileName}:`, error);
                reject(error);
              }
            });
            
          } catch (error) {
            console.error(`‚ùå Error processing ${fileName}:`, error);
            return {
              success: false,
              error: error.message,
              fileName: fileName
            };
          }
        }

        // Upload all photos for a jobdesk
        async function uploadJobdeskPhotos(jobNpk, jobName) {
          const beforeInput = document.getElementById(`photo_before_${jobNpk}`);
          const afterInput = document.getElementById(`photo_after_${jobNpk}`);
          const statusDiv = document.getElementById(`upload_status_${jobNpk}`);
          
          const uploadResults = {
            before: null,
            after: null
          };
          
          // Show upload status if there are photos to upload
          if (statusDiv && (beforeInput?.files[0] || afterInput?.files[0])) {
            statusDiv.classList.remove('hidden');
          }
          
          try {
            // Upload before photo if exists
            if (beforeInput && beforeInput.files[0]) {
              const beforeFile = beforeInput.files[0];
              const beforeFileName = `${currentUser.division}_${currentUser.name}_${jobName}_before_${new Date().getTime()}.jpg`;
              
              console.log(`üì∏ Processing before photo: ${beforeFileName}`);
              const beforeResult = await uploadPhotoToGoogleDrive(beforeFile, beforeFileName, jobName);
              uploadResults.before = beforeResult;
            }
            
            // Upload after photo if exists
            if (afterInput && afterInput.files[0]) {
              const afterFile = afterInput.files[0];
              const afterFileName = `${currentUser.division}_${currentUser.name}_${jobName}_after_${new Date().getTime()}.jpg`;
              
              console.log(`üì∏ Processing after photo: ${afterFileName}`);
              const afterResult = await uploadPhotoToGoogleDrive(afterFile, afterFileName, jobName);
              uploadResults.after = afterResult;
            }
            
            // Hide upload status
            if (statusDiv) {
              statusDiv.classList.add('hidden');
            }
            
            return uploadResults;
            
          } catch (error) {
            console.error('‚ùå Error uploading jobdesk photos:', error);
            
            // Hide upload status
            if (statusDiv) {
              statusDiv.classList.add('hidden');
            }
            
            return uploadResults;
          }
        }

        // Send WhatsApp message via Fonnte
        async function sendWhatsAppReport(message) {
          const FONNTE_TOKEN = 'your_fonnte_token_here'; // Ganti dengan token Fonnte Anda
          const TARGET_NUMBER = '6281234567890'; // Ganti dengan nomor tujuan
          
          try {
            console.log('üì± Sending WhatsApp report...');
            
            const response = await fetch('https://api.fonnte.com/send', {
              method: 'POST',
              headers: {
                'Authorization': FONNTE_TOKEN,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                target: TARGET_NUMBER,
                message: message,
                countryCode: '62'
              })
            });
            
            const result = await response.json();
            
            if (response.ok && result.status) {
              console.log('‚úÖ WhatsApp report sent successfully:', result);
              showToast('Laporan berhasil dikirim ke WhatsApp!', 'success');
              return true;
            } else {
              console.error('‚ùå Failed to send WhatsApp report:', result);
              showToast('Gagal mengirim laporan ke WhatsApp', 'error');
              return false;
            }
            
          } catch (error) {
            console.error('‚ùå Error sending WhatsApp report:', error);
            showToast('Error mengirim laporan ke WhatsApp', 'error');
            return false;
          }
        }

        // Handle checklist submission
        async function handleSubmitChecklist() {
          if (!currentUser || !currentShift) {
            showToast('Data login atau shift tidak lengkap!', 'error');
            return;
          }
          
          // Show loading state
          const submitBtn = document.getElementById('submitChecklist');
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.innerHTML = `
            <div class="flex items-center justify-center space-x-2">
              <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
              <span>Memproses...</span>
            </div>
          `;
          
          try {
            // Collect all checked items
            const checkedItems = {
              team: [],
              supplier: [],
              jobdesk: [],
              spg: [],
              reserve: {
                checked: document.getElementById('reserveStock').checked,
                display: document.getElementById('reserveDisplay').value,
                note: document.getElementById('reserveNote').value
              }
            };
            
            // Get team data with zones
            document.querySelectorAll('input[data-type="team"]:checked').forEach(checkbox => {
              const npk = checkbox.dataset.npk;
              const name = checkbox.dataset.name;
              const zoneSelect = document.getElementById(`zone_${npk}`);
              const zone = zoneSelect ? zoneSelect.value : '';
              
              checkedItems.team.push({
                npk: npk,
                name: name,
                zone: zone
              });
            });
            
            // Get supplier data
            document.querySelectorAll('input[data-type="supplier"]:checked').forEach(checkbox => {
              checkedItems.supplier.push(checkbox.dataset.npk);
            });
            
            // Get SPG data with brands
            document.querySelectorAll('input[data-type="spg"]:checked').forEach(checkbox => {
              const npk = checkbox.dataset.npk;
              const brand = checkbox.dataset.brand;
              
              checkedItems.spg.push({
                npk: npk,
                brand: brand
              });
            });
            
            // Get jobdesk data with comments and upload photos
            const jobdeskPromises = [];
            document.querySelectorAll('input[data-type="jobdesk"]:checked').forEach(checkbox => {
              const npk = checkbox.dataset.npk;
              const name = checkbox.dataset.name;
              const commentField = document.getElementById(`comment_text_${npk}`);
              const comment = commentField ? commentField.value : '';
              
              // Create promise for photo upload
              const jobdeskPromise = uploadJobdeskPhotos(npk, name).then(uploadResults => {
                return {
                  npk: npk,
                  name: name,
                  comment: comment,
                  photos: {
                    before: uploadResults.before,
                    after: uploadResults.after
                  }
                };
              });
              
              jobdeskPromises.push(jobdeskPromise);
            });
            
            // Wait for all photo uploads to complete
            if (jobdeskPromises.length > 0) {
              showToast('Mengupload foto ke Google Drive...', 'info');
            }
            
            const jobdeskResults = await Promise.all(jobdeskPromises);
            checkedItems.jobdesk = jobdeskResults;
            
            // Check if any photos failed to upload
            const failedUploads = jobdeskResults.filter(job => 
              (job.photos?.before && !job.photos.before.success) || 
              (job.photos?.after && !job.photos.after.success)
            );
            
            if (failedUploads.length > 0) {
              console.log('‚ö†Ô∏è Some photos failed to upload:', failedUploads);
              showToast('Beberapa foto gagal diupload, tapi laporan tetap akan dikirim', 'info');
            }
            
            // Create submission data
            const submissionData = {
              timestamp: new Date().toISOString(),
              leader: currentUser,
              shift: currentShift,
              checklist: checkedItems
            };
            
            console.log('üì§ Submitting checklist:', submissionData);
            
            // Generate and send WhatsApp report
            const reportMessage = generateWhatsAppReport(submissionData);
            console.log('üìù Generated report message:', reportMessage);
            
            // Send WhatsApp report
            const whatsappSent = await sendWhatsAppReport(reportMessage);
            
            // Try to save to Data SDK if available, but don't fail if not available
            try {
              if (window.dataSdk && window.dataSdk.create && typeof window.dataSdk.create === 'function') {
                const result = await window.dataSdk.create(submissionData);
                if (result && result.isOk) {
                  console.log('‚úÖ Data also saved to Canva Sheet');
                } else {
                  console.log('‚ö†Ô∏è Data SDK create failed, but continuing...');
                }
              } else {
                console.log('‚ö†Ô∏è Data SDK not available in this environment');
              }
            } catch (sdkError) {
              console.log('‚ö†Ô∏è Data SDK error (continuing anyway):', sdkError.message);
            }
            
            // Show success message
            if (whatsappSent) {
              showToast('Laporan berhasil dikirim ke WhatsApp!', 'success');
            } else {
              showToast('Checklist berhasil disubmit!', 'success');
            }
            
            // Reset everything and return to login
            setTimeout(() => {
              currentUser = null;
              currentShift = null;
              
              // Reset all forms and states
              resetAllForms();
              
              // Show login section
              document.getElementById('loginSection').classList.remove('hidden');
              document.getElementById('dashboardSection').classList.add('hidden');
              
              // Reset login form
              document.getElementById('loginForm').reset();
              document.getElementById('leaderName').disabled = true;
              document.getElementById('leaderName').innerHTML = '<option value="">-- Pilih divisi terlebih dahulu --</option>';
              
              showToast('Sistem telah direset. Silakan login kembali.', 'info');
            }, 3000);
            
          } catch (error) {
            console.error('‚ùå Error submitting checklist:', error);
            showToast('Gagal memproses checklist. Silakan coba lagi.', 'error');
          } finally {
            // Restore submit button
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        }

        // Data SDK handler
        const dataHandler = {
          onDataChanged(data) {
            console.log('üìä Data updated:', data.length, 'records');
          }
        };

        // Element SDK configuration
        const defaultConfig = {
          app_title: "Sistem Checklist Harian Leader",
          primary_color: "#3b82f6",
          success_color: "#10b981",
          background_color: "#f8fafc"
        };

        async function onConfigChange(config) {
          // Update app title
          const titleElement = document.querySelector('h1');
          if (titleElement) {
            titleElement.textContent = config.app_title || defaultConfig.app_title;
          }
          
          // Update colors
          const primaryColor = config.primary_color || defaultConfig.primary_color;
          const successColor = config.success_color || defaultConfig.success_color;
          const backgroundColor = config.background_color || defaultConfig.background_color;
          
          // Apply colors to elements
          document.body.style.background = `linear-gradient(to bottom right, ${backgroundColor}, #e0e7ff)`;
          
          // Update button colors
          document.querySelectorAll('.bg-blue-600').forEach(el => {
            el.style.backgroundColor = primaryColor;
          });
          
          document.querySelectorAll('.bg-green-600').forEach(el => {
            el.style.backgroundColor = successColor;
          });
        }

        function mapToCapabilities(config) {
          return {
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.success_color || defaultConfig.success_color,
                set: (value) => {
                  config.success_color = value;
                  window.elementSdk.setConfig({ success_color: value });
                }
              },
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          };
        }

        function mapToEditPanelValues(config) {
          return new Map([
            ["app_title", config.app_title || defaultConfig.app_title]
          ]);
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async function() {
          console.log('üéØ DOM loaded, initializing...');
          
          // Initialize Data SDK (optional - only if available)
          if (window.dataSdk && typeof window.dataSdk.init === 'function') {
            try {
              const initResult = await window.dataSdk.init(dataHandler);
              if (initResult.isOk) {
                console.log('‚úÖ Data SDK initialized successfully');
              } else {
                console.error('‚ùå Data SDK initialization failed:', initResult.error);
              }
            } catch (error) {
              console.error('‚ùå Data SDK error:', error);
            }
          } else {
            console.log('‚ö†Ô∏è Data SDK not available - running without data persistence');
          }
          
          // Initialize Element SDK (optional - only if available)
          if (window.elementSdk && typeof window.elementSdk.init === 'function') {
            try {
              await window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities,
                mapToEditPanelValues
              });
              console.log('‚úÖ Element SDK initialized successfully');
            } catch (error) {
              console.error('‚ùå Element SDK error:', error);
            }
          } else {
            console.log('‚ö†Ô∏è Element SDK not available - running with default styling');
          }
          
          // Initialize main application
          await init();
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99ad0311a1e86d1c',t:'MTc2MjUyMDQxMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
