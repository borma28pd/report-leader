<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Checklist Harian Leader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .checkbox-custom {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkbox-custom:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .checkbox-custom:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gradient-to-br from-blue-50 to-indigo-100">
  <main class="container mx-auto px-4 py-6 max-w-4xl"><!-- Header -->
   <header class="text-center mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Sistem Checklist Harian Leader</h1>
    <p class="text-gray-600">Kelola tugas harian tim dengan mudah dan efisien</p>
   </header><!-- Login Section -->
   <section id="loginSection" class="bg-white rounded-xl shadow-lg p-8 mb-6">
    <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Login Leader</h2>
    <form id="loginForm" class="space-y-6">
     <div><label for="division" class="block text-sm font-medium text-gray-700 mb-2">Pilih Divisi</label> <select id="division" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">-- Pilih Divisi --</option> <option value="food">Food</option> <option value="nfood">Non Food</option> <option value="nfm">NFM</option> <option value="kasir">Kasir</option> </select>
     </div>
     <div><label for="leaderName" class="block text-sm font-medium text-gray-700 mb-2">Nama Leader</label> <select id="leaderName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled> <option value="">-- Pilih divisi terlebih dahulu --</option> </select>
     </div>
     <div><label for="npk" class="block text-sm font-medium text-gray-700 mb-2">NPK (Password)</label> <input type="password" id="npk" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan NPK Anda">
     </div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105"> Login </button>
    </form>
   </section><!-- Main Dashboard -->
   <section id="dashboardSection" class="hidden"><!-- Welcome Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
     <div class="flex items-center justify-between">
      <div>
       <h2 class="text-2xl font-bold text-gray-800">Selamat Datang, <span id="welcomeName"></span></h2>
       <p class="text-gray-600">Divisi <span id="welcomeDivision"></span> | NPK: <span id="welcomeNPK"></span></p>
      </div><button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200"> Logout </button>
     </div>
    </div><!-- Shift Selection -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
     <h3 class="text-xl font-semibold text-gray-800 mb-4">Pilih Shift Kerja</h3>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><button class="shift-btn bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-3 px-6 rounded-lg transition duration-200" data-shift="pagi"> Shift Pagi </button> <button class="shift-btn bg-green-100 hover:bg-green-200 text-green-800 font-semibold py-3 px-6 rounded-lg transition duration-200" data-shift="siang"> Shift Siang </button>
     </div>
     <div id="selectedShift" class="mt-4 text-center text-gray-600 hidden">
      Shift terpilih: <span class="font-semibold"></span>
     </div>
    </div><!-- Checklist Sections -->
    <div id="checklistSections" class="space-y-6 hidden"><!-- Team Selection -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Tim yang Bekerja Hari Ini</h3>
      <div id="teamList" class="space-y-3"></div>
      <div class="mt-4 text-center"><button id="saveTeamBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200"> Simpan Tim yang Bekerja </button>
      </div>
      <div id="teamZoneSection" class="mt-6 hidden">
       <h4 class="text-lg font-semibold text-gray-700 mb-3">Penempatan Zona Kerja</h4>
       <div id="teamZoneList" class="space-y-3"></div>
      </div>
     </div><!-- Supplier Selection -->
     <div id="supplierSection" class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Supplier Kiriman Hari Ini</h3>
      <div id="supplierList" class="space-y-3"></div>
     </div><!-- Jobdesk Checklist -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Checklist Jobdesk</h3>
      <div id="jobdeskList" class="space-y-3"></div>
      <div id="jobdeskComments" class="mt-4 space-y-3"></div>
     </div><!-- Reserve Stock -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Turun Reserve</h3>
      <div class="space-y-4">
       <div class="flex items-center space-x-3"><input type="checkbox" id="reserveStock" class="checkbox-custom"> <label for="reserveStock" class="text-gray-700 font-medium">Ada turun reserve hari ini</label>
       </div>
       <div id="reserveComment" class="hidden space-y-3">
        <div><label for="reserveDisplay" class="block text-sm font-medium text-gray-700 mb-2">Display</label> <input type="text" id="reserveDisplay" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan display...">
        </div>
        <div><label for="reserveNote" class="block text-sm font-medium text-gray-700 mb-2">Keterangan Reserve</label> <textarea id="reserveNote" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Tuliskan detail reserve yang diambil..."></textarea>
        </div>
       </div>
      </div>
     </div><!-- SPG Selection -->
     <div id="spgSection" class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">SPG yang Bekerja Hari Ini</h3>
      <div id="spgList" class="space-y-3"></div>
     </div><!-- Submit Button -->
     <div class="text-center"><button id="submitChecklist" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-8 rounded-lg transition duration-200 transform hover:scale-105 shadow-lg"> Submit Checklist Harian </button>
     </div>
    </div>
   </section><!-- Confirmation Modal -->
   <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
     <div class="text-center">
      <div class="mb-4">
       <svg class="mx-auto h-12 w-12 text-yellow-500" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
       </svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Konfirmasi Submit</h3>
      <p class="text-gray-600 mb-6">Apakah data yang Anda buat sudah yakin dan benar?</p>
      <div class="flex space-x-4"><button id="confirmSubmit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"> Kirim </button> <button id="cancelSubmit" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"> Periksa Kembali </button>
      </div>
     </div>
    </div>
   </div>
  </main>
  <script>
        // Data from spreadsheet - will be loaded dynamically
        let spreadsheetData = {};

        let currentUser = null;
        let currentShift = null;

        // Enhanced data loading with real spreadsheet data
        async function loadSpreadsheetData() {
          console.log('üîó Trying to connect to Apps Script...');
          
          try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbwAcs-_h6SNPoZObj9NZSDLuYrrnTGodXzv_cuJ963nqGhQ_JxlPRU9RQFsALy_9rlt/exec', {
              method: 'GET',
              mode: 'cors'
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log('üìä Successfully loaded data from spreadsheet:', data);
            console.log('üìù Available sheets:', Object.keys(data));
            
            // Validate data structure
            const hasValidData = Object.keys(data).some(key => 
              Array.isArray(data[key]) && data[key].length > 0
            );
            
            if (hasValidData) {
              console.log('üéâ Using REAL spreadsheet data');
              showToast('Data berhasil dimuat dari server!', 'success');
              spreadsheetData = data; // Update with real data
              return data;
            }
            
          } catch (error) {
            console.log(`‚ùå Error loading spreadsheet data: ${error}`);
            console.log('‚ö†Ô∏è Using fallback sample data');
            showToast('Menggunakan data sample (koneksi server gagal)', 'info');
          }

          return spreadsheetData; // Return existing data (real or fallback)
        }

        // Get data for specific division and type
        function getDataForDivision(division, type) {
          console.log(`üîç Getting ${type} data for division: ${division}`);
          
          let sheetName = '';
          
          switch (type) {
            case 'team':
              sheetName = division.toLowerCase();
              break;
            case 'spg':
              if (division === 'food') {
                sheetName = 'spg food';
              } else if (division === 'nfood') {
                sheetName = 'spg nfood';
              } else {
                console.log(`‚ÑπÔ∏è No SPG data for division: ${division}`);
                return [];
              }
              break;
            case 'supplier':
              if (division === 'food') {
                sheetName = 'supplier food';
              } else if (division === 'nfood') {
                sheetName = 'supplier nfood';
              } else if (division === 'nfm') {
                sheetName = 'supplier nfm';
              } else {
                console.log(`‚ÑπÔ∏è No supplier data for division: ${division}`);
                return [];
              }
              break;
            case 'jobdesk':
              sheetName = '7 jobdesk';
              break;
          }
          
          console.log(`üîé Looking for sheet: "${sheetName}"`);
          console.log(`üìã Available sheets:`, Object.keys(spreadsheetData));
          
          const data = spreadsheetData[sheetName] || [];
          console.log(`üìä Found ${data.length} items in ${sheetName}:`, data);
          
          return data;
        }

        // Toast notification system
        function showToast(message, type = 'info') {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.textContent = message;
          document.body.appendChild(toast);
          
          setTimeout(() => {
            toast.remove();
          }, 3000);
        }

        // Reset all form states
        function resetAllForms() {
          // Reset all checkboxes
          document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
          });
          
          // Reset reserve fields
          document.getElementById('reserveNote').value = '';
          document.getElementById('reserveDisplay').value = '';
          document.getElementById('reserveComment').classList.add('hidden');
          
          // Reset team zone section
          document.getElementById('teamZoneSection').classList.add('hidden');
          document.getElementById('teamZoneList').innerHTML = '';
          
          // Reset jobdesk comments
          document.getElementById('jobdeskComments').innerHTML = '';
          

          
          // Reset shift selection
          document.querySelectorAll('.shift-btn').forEach(btn => {
            btn.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-200');
          });
          
          // Hide sections
          document.getElementById('checklistSections').classList.add('hidden');
          document.getElementById('selectedShift').classList.add('hidden');
          
          // Reset current shift
          currentShift = null;
          
          console.log('üîÑ All forms reset for new session');
        }

        // Initialize application
        async function init() {
          console.log('üöÄ Initializing application...');
          
          // Load spreadsheet data
          await loadSpreadsheetData();
          
          // Setup event listeners
          setupEventListeners();
          
          console.log('‚úÖ Application initialized successfully');
        }

        // Setup all event listeners
        function setupEventListeners() {
          // Division change handler
          document.getElementById('division').addEventListener('change', function() {
            const division = this.value;
            const leaderSelect = document.getElementById('leaderName');
            const npkInput = document.getElementById('npk');
            
            if (division) {
              const leaders = getDataForDivision(division, 'team');
              console.log(`üë• Loading ${leaders.length} leaders for ${division}:`, leaders);
              
              leaderSelect.innerHTML = '<option value="">-- Pilih Leader --</option>';
              leaders.forEach(leader => {
                const option = document.createElement('option');
                option.value = JSON.stringify(leader);
                option.textContent = leader.name;
                leaderSelect.appendChild(option);
              });
              
              leaderSelect.disabled = false;
              npkInput.value = '';
            } else {
              leaderSelect.innerHTML = '<option value="">-- Pilih divisi terlebih dahulu --</option>';
              leaderSelect.disabled = true;
              npkInput.value = '';
            }
          });

          // Leader selection handler - NPK is now manual input
          document.getElementById('leaderName').addEventListener('change', function() {
            const npkInput = document.getElementById('npk');
            npkInput.value = ''; // Clear NPK field when leader changes
          });

          // Login form handler
          document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const division = document.getElementById('division').value;
            const leaderData = document.getElementById('leaderName').value;
            const inputNpk = document.getElementById('npk').value;
            
            if (!division || !leaderData || !inputNpk) {
              showToast('Mohon lengkapi semua field!', 'error');
              return;
            }
            
            const leader = JSON.parse(leaderData);
            
            // Validate NPK matches the selected leader
            if (inputNpk !== leader.npk) {
              showToast('NPK tidak sesuai dengan leader yang dipilih!', 'error');
              return;
            }
            
            currentUser = {
              division: division,
              name: leader.name,
              npk: leader.npk
            };
            
            console.log('üë§ User logged in:', currentUser);
            
            // Reset all form states
            resetAllForms();
            
            showDashboard();
          });

          // Shift selection handlers
          document.querySelectorAll('.shift-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              // Remove active state from all buttons
              document.querySelectorAll('.shift-btn').forEach(b => {
                b.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-200');
              });
              
              // Add active state to clicked button
              this.classList.add('ring-2', 'ring-blue-500', 'bg-blue-200');
              
              currentShift = this.dataset.shift;
              const shiftText = this.textContent;
              
              document.getElementById('selectedShift').classList.remove('hidden');
              document.getElementById('selectedShift').querySelector('span').textContent = shiftText;
              
              console.log('‚è∞ Shift selected:', currentShift);
              loadChecklistSections();
            });
          });

          // Reserve stock checkbox handler
          document.getElementById('reserveStock').addEventListener('change', function() {
            const commentDiv = document.getElementById('reserveComment');
            if (this.checked) {
              commentDiv.classList.remove('hidden');
            } else {
              commentDiv.classList.add('hidden');
              document.getElementById('reserveNote').value = '';
              document.getElementById('reserveDisplay').value = '';
            }
          });

          // Save team button handler
          document.getElementById('saveTeamBtn').addEventListener('click', function() {
            const checkedTeam = [];
            document.querySelectorAll('input[data-type="team"]:checked').forEach(checkbox => {
              checkedTeam.push({
                npk: checkbox.dataset.npk,
                name: checkbox.dataset.name
              });
            });
            
            if (checkedTeam.length === 0) {
              showToast('Pilih minimal satu anggota tim!', 'error');
              return;
            }
            
            showTeamZoneSection(checkedTeam);
            showToast('Tim berhasil disimpan! Silakan atur zona kerja.', 'success');
          });

          // Logout handler
          document.getElementById('logoutBtn').addEventListener('click', function() {
            currentUser = null;
            currentShift = null;
            
            // Reset all forms and states
            resetAllForms();
            
            // Show login section
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            
            // Reset login form
            document.getElementById('loginForm').reset();
            document.getElementById('leaderName').disabled = true;
            document.getElementById('leaderName').innerHTML = '<option value="">-- Pilih divisi terlebih dahulu --</option>';
            
            showToast('Logout berhasil!', 'success');
          });

          // Submit checklist handler - show confirmation modal
          document.getElementById('submitChecklist').addEventListener('click', function(e) {
            e.preventDefault();
            
            if (!currentUser || !currentShift) {
              showToast('Data login atau shift tidak lengkap!', 'error');
              return;
            }
            
            // Show confirmation modal
            document.getElementById('confirmationModal').classList.remove('hidden');
          });

          // Confirm submit handler
          document.getElementById('confirmSubmit').addEventListener('click', function() {
            // Hide modal
            document.getElementById('confirmationModal').classList.add('hidden');
            
            // Process the actual submission
            handleSubmitChecklist();
          });

          // Cancel submit handler
          document.getElementById('cancelSubmit').addEventListener('click', function() {
            // Just hide the modal, keep all data intact
            document.getElementById('confirmationModal').classList.add('hidden');
          });
        }

        // Show dashboard after login
        function showDashboard() {
          document.getElementById('loginSection').classList.add('hidden');
          document.getElementById('dashboardSection').classList.remove('hidden');
          
          // Update welcome message
          document.getElementById('welcomeName').textContent = currentUser.name;
          document.getElementById('welcomeDivision').textContent = currentUser.division.toUpperCase();
          document.getElementById('welcomeNPK').textContent = currentUser.npk;
          
          showToast(`Selamat datang, ${currentUser.name}!`, 'success');
        }

        // Show team zone section
        function showTeamZoneSection(teamMembers) {
          const zoneSection = document.getElementById('teamZoneSection');
          const zoneList = document.getElementById('teamZoneList');
          
          zoneList.innerHTML = '';
          
          const zones = ['Zona A', 'Zona B', 'Zona C', 'Zona D', 'Kasir', 'Customer Service', 'Gudang'];
          
          teamMembers.forEach(member => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
            div.innerHTML = `
              <span class="font-medium text-gray-700">${member.name}</span>
              <select id="zone_${member.npk}" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">-- Pilih Zona --</option>
                ${zones.map(zone => `<option value="${zone}">${zone}</option>`).join('')}
              </select>
            `;
            zoneList.appendChild(div);
          });
          
          zoneSection.classList.remove('hidden');
        }

        // Load checklist sections based on division and shift
        function loadChecklistSections() {
          console.log('üìã Loading checklist sections for:', currentUser.division);
          
          // Show checklist sections
          document.getElementById('checklistSections').classList.remove('hidden');
          
          // Load team data
          loadTeamSection();
          
          // Load supplier data
          loadSupplierSection();
          
          // Load jobdesk data
          loadJobdeskSection();
          
          // Load SPG data
          loadSPGSection();
        }

        // Load team section
        function loadTeamSection() {
          const teamData = getDataForDivision(currentUser.division, 'team');
          const teamList = document.getElementById('teamList');
          
          teamList.innerHTML = '';
          
          teamData.forEach(member => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3';
            div.innerHTML = `
              <input type="checkbox" id="team_${member.npk}" class="checkbox-custom" data-type="team" data-npk="${member.npk}" data-name="${member.name}">
              <label for="team_${member.npk}" class="text-gray-700 font-medium">${member.name}</label>
            `;
            teamList.appendChild(div);
          });
          
          console.log(`üë• Loaded ${teamData.length} team members`);
        }

        // Load supplier section
        function loadSupplierSection() {
          const supplierData = getDataForDivision(currentUser.division, 'supplier');
          const supplierSection = document.getElementById('supplierSection');
          const supplierList = document.getElementById('supplierList');
          
          if (supplierData.length === 0) {
            supplierSection.classList.add('hidden');
            console.log('üì¶ No supplier data for this division');
            return;
          }
          
          supplierSection.classList.remove('hidden');
          supplierList.innerHTML = '';
          
          supplierData.forEach(supplier => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3';
            div.innerHTML = `
              <input type="checkbox" id="supplier_${supplier.npk}" class="checkbox-custom" data-type="supplier" data-npk="${supplier.npk}">
              <label for="supplier_${supplier.npk}" class="text-gray-700 font-medium">${supplier.name}</label>
            `;
            supplierList.appendChild(div);
          });
          
          console.log(`üì¶ Loaded ${supplierData.length} suppliers`);
        }

        // Load jobdesk section
        function loadJobdeskSection() {
          const jobdeskData = getDataForDivision(currentUser.division, 'jobdesk');
          const jobdeskList = document.getElementById('jobdeskList');
          
          jobdeskList.innerHTML = '';
          
          jobdeskData.forEach(job => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3';
            div.innerHTML = `
              <input type="checkbox" id="jobdesk_${job.npk}" class="checkbox-custom jobdesk-checkbox" data-type="jobdesk" data-npk="${job.npk}" data-name="${job.name}">
              <label for="jobdesk_${job.npk}" class="text-gray-700 font-medium">${job.name}</label>
            `;
            jobdeskList.appendChild(div);
          });
          
          // Add event listeners for jobdesk checkboxes
          document.querySelectorAll('.jobdesk-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
              const jobName = this.dataset.name;
              const jobNpk = this.dataset.npk;
              const commentsContainer = document.getElementById('jobdeskComments');
              
              if (this.checked) {
                // Create comment field
                const commentDiv = document.createElement('div');
                commentDiv.id = `comment_${jobNpk}`;
                commentDiv.className = 'fade-in';
                commentDiv.innerHTML = `
                  <label for="comment_text_${jobNpk}" class="block text-sm font-medium text-gray-700 mb-2">Komentar untuk ${jobName}</label>
                  <textarea id="comment_text_${jobNpk}" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Tuliskan komentar untuk ${jobName}..."></textarea>
                `;
                commentsContainer.appendChild(commentDiv);
              } else {
                // Remove comment field
                const commentDiv = document.getElementById(`comment_${jobNpk}`);
                if (commentDiv) {
                  commentDiv.remove();
                }
              }
            });
          });
          
          console.log(`üìù Loaded ${jobdeskData.length} jobdesk items`);
        }

        // Load SPG section
        function loadSPGSection() {
          const spgData = getDataForDivision(currentUser.division, 'spg');
          const spgSection = document.getElementById('spgSection');
          const spgList = document.getElementById('spgList');
          
          if (spgData.length === 0) {
            spgSection.classList.add('hidden');
            console.log('üë©‚Äçüíº No SPG data for this division');
            return;
          }
          
          spgSection.classList.remove('hidden');
          spgList.innerHTML = '';
          
          spgData.forEach(spg => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3';
            // Display brand automatically from spreadsheet data
            const brandText = spg.brand ? ` (${spg.brand})` : '';
            div.innerHTML = `
              <input type="checkbox" id="spg_${spg.npk}" class="checkbox-custom" data-type="spg" data-npk="${spg.npk}" data-brand="${spg.brand || ''}">
              <label for="spg_${spg.npk}" class="text-gray-700 font-medium">${spg.name}${brandText}</label>
            `;
            spgList.appendChild(div);
          });
          
          console.log(`üë©‚Äçüíº Loaded ${spgData.length} SPG members`);
        }

        // Generate WhatsApp report message
        function generateWhatsAppReport(submissionData) {
          const now = new Date();
          const hour = now.getHours();
          
          // Determine greeting based on time
          let greeting = '';
          if (hour >= 12 && hour < 18) {
            greeting = 'Selamat siang';
          } else if (hour >= 18 || hour < 6) {
            greeting = 'Selamat malam';
          } else {
            greeting = 'Selamat pagi';
          }
          
          // Get team names from spreadsheet data
          const teamData = getDataForDivision(currentUser.division, 'team');
          const teamNames = submissionData.checklist.team.map(member => {
            const teamMember = teamData.find(t => t.npk === member.npk);
            return teamMember ? `${teamMember.name} (${member.zone || 'Zona belum ditentukan'})` : member.name;
          });
          
          // Get supplier names from spreadsheet data
          const supplierData = getDataForDivision(currentUser.division, 'supplier');
          const supplierNames = submissionData.checklist.supplier.map(supplierNpk => {
            const supplier = supplierData.find(s => s.npk === supplierNpk);
            return supplier ? supplier.name : supplierNpk;
          });
          
          // Format jobdesk with comments
          const jobdeskList = submissionData.checklist.jobdesk.map(job => {
            const comment = job.comment ? ` (${job.comment})` : '';
            return `- ${job.name}${comment}`;
          }).join('\n');
          
          // Format reserve information
          let reserveInfo = 'Tidak ada';
          if (submissionData.checklist.reserve.checked) {
            const display = submissionData.checklist.reserve.display || 'Tidak disebutkan';
            const note = submissionData.checklist.reserve.note || 'Tidak ada keterangan';
            reserveInfo = `Display: ${display}\nKeterangan: ${note}`;
          }
          
          // Get SPG names with brands from spreadsheet data
          const spgData = getDataForDivision(currentUser.division, 'spg');
          const spgNames = submissionData.checklist.spg.map(spgItem => {
            const spg = spgData.find(s => s.npk === spgItem.npk);
            const brand = spgItem.brand || (spg ? spg.brand : '');
            const brandText = brand ? ` (${brand})` : '';
            return spg ? `${spg.name}${brandText}` : spgItem.npk;
          });
          
          // Determine closing greeting
          let closingGreeting = '';
          if (hour >= 12 && hour < 18) {
            closingGreeting = 'selamat siang';
          } else if (hour >= 18 || hour < 6) {
            closingGreeting = 'selamat malam';
          } else {
            closingGreeting = 'selamat pagi';
          }
          
          // Build the message
          const message = `${greeting}

Nama: ${submissionData.leader.name}
Leader Shift: ${submissionData.shift === 'pagi' ? 'Shift Pagi' : 'Shift Siang'}

Dengan team karyawan total: ${teamNames.length} orang
${teamNames.length > 0 ? teamNames.map(name => `- ${name}`).join('\n') : '- Tidak ada tim yang dipilih'}

Supplier yang hari ini datang:
${supplierNames.length > 0 ? supplierNames.map(name => `- ${name}`).join('\n') : '- Tidak ada supplier'}

Jobdesk terlaksana:
${jobdeskList || '- Tidak ada jobdesk yang diselesaikan'}

Turun reserve/isi display:
${reserveInfo}

SPG yang bertugas pada shift ini:
${spgNames.length > 0 ? spgNames.map(name => `- ${name}`).join('\n') : '- Tidak ada SPG'}

Atas perhatiannya saya ucapkan terimakasih
${closingGreeting}`;

          return message;
        }

        // Send WhatsApp message via Fonnte
        async function sendWhatsAppReport(message) {
          const FONNTE_TOKEN = 'C9BxKbVQyGzp5JRxG1re'; // Ganti dengan token Fonnte Anda
          const TARGET_NUMBER = '120363422961733756@g.us'; // Ganti dengan nomor tujuan
          
          try {
            console.log('üì± Sending WhatsApp report...');
            
            const response = await fetch('https://api.fonnte.com/send', {
              method: 'POST',
              headers: {
                'Authorization': FONNTE_TOKEN,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                target: TARGET_NUMBER,
                message: message,
                countryCode: '62'
              })
            });
            
            const result = await response.json();
            
            if (response.ok && result.status) {
              console.log('‚úÖ WhatsApp report sent successfully:', result);
              showToast('Laporan berhasil dikirim ke WhatsApp!', 'success');
              return true;
            } else {
              console.error('‚ùå Failed to send WhatsApp report:', result);
              showToast('Gagal mengirim laporan ke WhatsApp', 'error');
              return false;
            }
            
          } catch (error) {
            console.error('‚ùå Error sending WhatsApp report:', error);
            showToast('Error mengirim laporan ke WhatsApp', 'error');
            return false;
          }
        }

        // Handle checklist submission
        async function handleSubmitChecklist() {
          if (!currentUser || !currentShift) {
            showToast('Data login atau shift tidak lengkap!', 'error');
            return;
          }
          
          // Collect all checked items
          const checkedItems = {
            team: [],
            supplier: [],
            jobdesk: [],
            spg: [],
            reserve: {
              checked: document.getElementById('reserveStock').checked,
              display: document.getElementById('reserveDisplay').value,
              note: document.getElementById('reserveNote').value
            }
          };
          
          // Get team data with zones
          document.querySelectorAll('input[data-type="team"]:checked').forEach(checkbox => {
            const npk = checkbox.dataset.npk;
            const name = checkbox.dataset.name;
            const zoneSelect = document.getElementById(`zone_${npk}`);
            const zone = zoneSelect ? zoneSelect.value : '';
            
            checkedItems.team.push({
              npk: npk,
              name: name,
              zone: zone
            });
          });
          
          // Get supplier data
          document.querySelectorAll('input[data-type="supplier"]:checked').forEach(checkbox => {
            checkedItems.supplier.push(checkbox.dataset.npk);
          });
          
          // Get jobdesk data with comments
          document.querySelectorAll('input[data-type="jobdesk"]:checked').forEach(checkbox => {
            const npk = checkbox.dataset.npk;
            const name = checkbox.dataset.name;
            const commentField = document.getElementById(`comment_text_${npk}`);
            const comment = commentField ? commentField.value : '';
            
            checkedItems.jobdesk.push({
              npk: npk,
              name: name,
              comment: comment
            });
          });
          
          // Get SPG data with brands
          document.querySelectorAll('input[data-type="spg"]:checked').forEach(checkbox => {
            const npk = checkbox.dataset.npk;
            const brand = checkbox.dataset.brand;
            
            checkedItems.spg.push({
              npk: npk,
              brand: brand
            });
          });
          
          // Create submission data
          const submissionData = {
            timestamp: new Date().toISOString(),
            leader: currentUser,
            shift: currentShift,
            checklist: checkedItems
          };
          
          console.log('üì§ Submitting checklist:', submissionData);
          
          try {
            // Save to Data SDK
            const result = await window.dataSdk.create(submissionData);
            
            if (result.isOk) {
              showToast('Checklist berhasil disimpan!', 'success');
              
              // Generate and send WhatsApp report
              const reportMessage = generateWhatsAppReport(submissionData);
              console.log('üìù Generated report message:', reportMessage);
              
              // Send WhatsApp report
              await sendWhatsAppReport(reportMessage);
              
              // Reset everything and return to login
              setTimeout(() => {
                currentUser = null;
                currentShift = null;
                
                // Reset all forms and states
                resetAllForms();
                
                // Show login section
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('dashboardSection').classList.add('hidden');
                
                // Reset login form
                document.getElementById('loginForm').reset();
                document.getElementById('leaderName').disabled = true;
                document.getElementById('leaderName').innerHTML = '<option value="">-- Pilih divisi terlebih dahulu --</option>';
                
                showToast('Sistem telah direset. Silakan login kembali.', 'info');
              }, 3000); // Extended to 3 seconds to allow WhatsApp sending
              
            } else {
              throw new Error(result.error.message);
            }
            
          } catch (error) {
            console.error('‚ùå Error submitting checklist:', error);
            showToast('Gagal menyimpan checklist. Silakan coba lagi.', 'error');
          }
        }

        // Data SDK handler
        const dataHandler = {
          onDataChanged(data) {
            console.log('üìä Data updated:', data.length, 'records');
          }
        };

        // Element SDK configuration
        const defaultConfig = {
          app_title: "Sistem Checklist Harian Leader",
          primary_color: "#3b82f6",
          success_color: "#10b981",
          background_color: "#f8fafc"
        };

        async function onConfigChange(config) {
          // Update app title
          const titleElement = document.querySelector('h1');
          if (titleElement) {
            titleElement.textContent = config.app_title || defaultConfig.app_title;
          }
          
          // Update colors
          const primaryColor = config.primary_color || defaultConfig.primary_color;
          const successColor = config.success_color || defaultConfig.success_color;
          const backgroundColor = config.background_color || defaultConfig.background_color;
          
          // Apply colors to elements
          document.body.style.background = `linear-gradient(to bottom right, ${backgroundColor}, #e0e7ff)`;
          
          // Update button colors
          document.querySelectorAll('.bg-blue-600').forEach(el => {
            el.style.backgroundColor = primaryColor;
          });
          
          document.querySelectorAll('.bg-green-600').forEach(el => {
            el.style.backgroundColor = successColor;
          });
        }

        function mapToCapabilities(config) {
          return {
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (value) => {
                  config.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => config.success_color || defaultConfig.success_color,
                set: (value) => {
                  config.success_color = value;
                  window.elementSdk.setConfig({ success_color: value });
                }
              },
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          };
        }

        function mapToEditPanelValues(config) {
          return new Map([
            ["app_title", config.app_title || defaultConfig.app_title]
          ]);
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async function() {
          console.log('üéØ DOM loaded, initializing...');
          
          // Initialize Data SDK
          try {
            const initResult = await window.dataSdk.init(dataHandler);
            if (initResult.isOk) {
              console.log('‚úÖ Data SDK initialized successfully');
            } else {
              console.error('‚ùå Data SDK initialization failed:', initResult.error);
            }
          } catch (error) {
            console.error('‚ùå Data SDK error:', error);
          }
          
          // Initialize Element SDK
          if (window.elementSdk) {
            try {
              await window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities,
                mapToEditPanelValues
              });
              console.log('‚úÖ Element SDK initialized successfully');
            } catch (error) {
              console.error('‚ùå Element SDK error:', error);
            }
          }
          
          // Initialize main application
          await init();
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99a5f6e7240fb5ba',t:'MTc2MjQ0NjUxMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>

</html>
